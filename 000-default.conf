#Rewrite Rules
#Force SSL
RewriteEngine on
ReWriteCond %{SERVER_PORT} !^443$
RewriteRule ^/(.*) https://%{HTTP_HOST}/$1 [NC,R,L]

ServerName catamelmoonshotdemo

<VirtualHost *:443>
    DocumentRoot "/var/www/html"

    SSLEngine on

    #Disable CRIME vulernability v2.4+
    SSLCompression off

    #Clean SSL Issues and enable perfect forward secrecy
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1
    SSLHonorCipherOrder on
    SSLCipherSuite "EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 \
EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 \
EECDH EDH+aRSA !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !RC4"

    #SSL Cert Stuff
    SSLCertificateFile    /etc/httpd/ssl/domain.crt
    SSLCertificateKeyFile /etc/httpd/ssl/domain.key
    #SSLCertificateChainFile /etc/httpd/ssl/serverchain.pem

    SSLProxyEngine on
    #Bypassing certicate checking on self-signed client cert
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off

    ProxyPreserveHost on
    RequestHeader set X-Forwarded-Proto "https" env=HTTPS

  ProxyPass /auth "http://localhost:3000/auth"
  ProxyPassReverse /auth "http://localhost:3000/auth"
  ProxyPass /explorer "http://localhost:3000/explorer"
  ProxyPassReverse /explorer "http://localhost:3000/explorer"
  ProxyPass /api "http://localhost:3000/api"
  ProxyPassReverse /api "http://localhost:3000/api"

  ShibCompatValidUser On

  <Proxy *>
      Order deny,allow
      Allow from all
  </Proxy>

  <Location /auth/moonshot>
    RequestHeader set Proxy-Remote-User %{GSS_NAME}e
    AuthType GSSAPI
    AuthName "Moonshot Login"
    GssapiConnectionBound On
    Order allow,deny
    Require valid-user
    Allow from all
  </Location>

  <Location /auth/shibsp>
    RequestHeader set Proxy-Remote-User %{REMOTE_USER}s
    AuthType shibboleth
    ShibRequestSetting requireSession 1
    require shib-session
  </Location>

</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
